{{ define "content" }}
{{ if .Feature }}
<section class="details">
    <h2 class="details-header">Topic: {{ .Feature.Name }}</h2>
    <p><strong>Source Device:</strong>
        <a href="/devices/{{ .FeatureSource.SourceID }}" hx-get="/devices/{{ .FeatureSource.SourceID }}" hx-target="#main-content" hx-swap="innerHTML" hx-push-url="true">
            {{ .FeatureSource.SourceName }}
        </a>
    </p>

    <h3>Subscribers:</h3>
    <ul>
    {{ range .Subscriptions }}
        <li>
            <a href="/devices/{{ .ID }}" hx-get="/devices/{{ .ID }}" hx-target="#main-content" hx-swap="innerHTML" hx-push-url="true">{{ .Name }}</a>
        </li>
    {{ else }}
        <li>No subscribers.</li>
    {{ end }}
    </ul>
    <article class="feature">
        <h4 class="feature-name">{{ .Feature.Name }}</h4>
        <p class="feature-desc">{{ .Feature.Description }}</p>
        <h5>Methods:</h5>
        <ul>
            {{ if .Feature.Methods.Data.IsDefined }}
            <li>
                <strong>Data</strong> — {{ .Feature.Methods.Data.Description }}
                {{ template "method_schema" .Feature.Methods.Data }}
            </li>
            {{ end }}
            {{ if .Feature.Methods.Status.IsDefined }}
            <li>
                <strong>Status</strong> — {{ .Feature.Methods.Status.Description }}
                {{ template "method_schema" .Feature.Methods.Status }}
            </li>
            {{ end }}
            {{ if .Feature.Methods.Command.IsDefined }}
            <li>
                <strong>Command</strong> — {{ .Feature.Methods.Command.Description }}
                {{ template "method_schema" .Feature.Methods.Command }}
            </li>
            {{ end }}
            {{ if .Feature.Methods.Query.IsDefined }}
            <li>
                <strong>Query</strong> — {{ .Feature.Methods.Query.Description }}
                {{ template "method_schema" .Feature.Methods.Query }}
            </li>
            {{ end }}
        </ul>
    </article>
    <h3>Live Messages</h2>
    <div id="messages" hx-ext="sse" sse-connect="/events/topics/{{ .Feature.Name }}" sse-swap="message">
        <!-- New messages will be appended here -->
    </div>
</section>
{{ else }}
<div class="default-content">
    <h2>Feature Overview</h2>
    <p>Select a feature from the list on the left to view its details, schema, and live message stream.</p>
    {{ if .Features }}
    <p>Currently {{ len .Features }} feature(s) are available in the system.</p>
    {{ else }}
    <p>No features are currently available. Features are created automatically when devices with capabilities connect to the system.</p>
    {{ end }}
</div>
{{ end }}
{{ end }}

{{ define "method_schema" }}
    {{ if .InputSchema }}
    <h6>Input Schema:</h6>
    <dl class="schema">
        {{ range $key, $schema := .InputSchema }}
        <dt><strong>{{ $key }}</strong> <small class="schema-type">({{ $schema.Type }})</small></dt>
        <dd>
            {{ if $schema.Unit }}Unit: {{ $schema.Unit }}<br>{{ end }}
            {{ if $schema.Description }}{{ $schema.Description }}<br>{{ end }}
            {{ if $schema.Range }}Range: {{ index $schema.Range 0 }} to {{ index $schema.Range 1 }}<br>{{ end }}
            {{ if $schema.Enum }}Enum: {{ join $schema.Enum ", " }}<br>{{ end }}
        </dd>
        {{ end }}
    </dl>
    {{ end }}

    {{ if .OutputSchema }}
    <h6>Output Schema:</h6>
    <dl class="schema">
        {{ range $key, $schema := .OutputSchema }}
        <dt><strong>{{ $key }}</strong> <small class="schema-type">({{ $schema.Type }})</small></dt>
        <dd>
            {{ if $schema.Unit }}Unit: {{ $schema.Unit }}<br>{{ end }}
            {{ if $schema.Description }}{{ $schema.Description }}<br>{{ end }}
            {{ if $schema.Range }}Range: {{ index $schema.Range 0 }} to {{ index $schema.Range 1 }}<br>{{ end }}
            {{ if $schema.Enum }}Enum: {{ join $schema.Enum ", " }}<br>{{ end }}
        </dd>
        {{ end }}
    </dl>
    {{ end }}
{{ end }}